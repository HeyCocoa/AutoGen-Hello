# NMPA医疗器械数据采集项目

## 使用方法
```bash
# 激活虚拟环境
.\venv\Scripts\activate

# 第一阶段：收集列表页数据并筛选
python phase1_collect.py
# 输出：phase1_result.xlsx（4个sheet，按产品分类）

# 人工检查筛选结果，删除不需要的行

# 第二阶段：获取详情页完整数据
python phase2_detail.py
# 输出：nmpa_data.xlsx
```

## 文件说明
- `phase1_collect.py` - 第一阶段：搜索关键词，收集列表页，筛选后保存
- `phase2_detail.py` - 第二阶段：根据注册证编号获取详情页数据
- `browser_utils.py` - 浏览器工具函数
- `keywords.py` - 配置文件（产品信息、搜索关键词、筛选规则）

## 产品列表
| ID | 简称 | 中文名 | 筛选条件 |
|----|------|--------|----------|
| 1 | Gastro Panel | 轮状病毒/腺病毒/诺如病毒/星状病毒联合检测试剂盒(胶体金法) | 包含"检测试剂盒"且"胶体金法" |
| 2 | FOB + Tf | 便隐血(血红蛋白)/转铁蛋白联合检测 | 包含(便隐血/血红蛋白/FOB)且(转铁蛋白/Transferrin) |
| 3 | H.pylori Ag | 幽门螺杆菌抗原检测试剂盒 | 包含"抗原"且"检测试剂盒" |
| 4 | Syphilis | 梅毒螺旋体抗体检测试剂盒 | 包含"抗体"且"检测试剂盒" |

## 注意事项
- 需要安装Chrome浏览器（版本143）
- 如Chrome版本不同，修改 `browser_utils.py` 中的 `version_main` 参数
- 运行时不要操作自动打开的Chrome窗口
- 第一阶段输出的Excel有4个sheet（product1-4），可人工删除不需要的行
- 如果产品名称包含"..."（被截断），会自动保留，详情阶段会获取完整名称

## 踩坑记录

### 1. 分页状态丢失问题
**问题**: NMPA网站使用JavaScript控制分页，URL不会随页码变化。点击详情后用`driver.back()`返回，页面会重置到第1页。

**解决方案**: 采用两阶段采集，第一阶段只翻页收集列表数据，第二阶段用注册证编号直接搜索获取详情，避免翻页问题。

### 2. 详情页数据提取
- 表格选择器: `#dataTable tbody tr`
- 每行两个td，第一个是key，第二个是value
- 用`.cell`子元素获取文本
- 跳过key为"注"的行（是链接不是数据）

### 3. 瑞数反爬
**解决方案**: 使用`undetected-chromedriver`库，并指定正确的Chrome版本号。

### 4. 产品名称截断
**问题**: 列表页产品名称过长会显示为"..."。

**解决方案**: 筛选时如果名称包含"..."直接保留，第二阶段获取详情时会得到完整名称。

### 5. 搜索结果页输入框选择器
**问题**: 首页和搜索结果页的搜索框选择器不同，用错选择器会误操作左侧的select下拉框。

- 首页搜索框: `.search-input input.el-input__inner`
- 搜索结果页搜索框: `.input-with-select input.el-input__inner`

**解决方案**: 第二阶段优化后，首次从首页进入用`.search-input`，后续在搜索结果页换编号用`.input-with-select`。

### 6. 第二阶段优化：避免重复初始化
**问题**: 原来每条记录都要从首页重新进入，太慢。

**解决方案**:
- 首次用第一条编号从首页搜索进入结果页
- 后续直接在搜索结果页清空输入框，输入新编号搜索
- 点击详情后用`driver.back()`返回搜索结果页继续

### 7. 断点续传
**问题**: 采集中断后需要从头开始。

**解决方案**: 启动时读取`nmpa_data.xlsx`已有数据，跳过已采集的注册证编号。

### 8. Excel文件被占用
**问题**: 保存时如果Excel文件被打开会报`PermissionError`。

**解决方案**: 运行采集时不要打开`nmpa_data.xlsx`文件。
