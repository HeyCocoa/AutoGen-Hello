# NMPA医疗器械数据采集项目 - 失败记录与踩坑清单

只保留失败过的方案、踩坑记录和被优化掉的原因，避免以后再踩同样的坑。

## 已失败 / 被优化掉的做法（原因总结）

### -1. 轻量级抓取（requests/bs4）直接拉页面
**失败原因**: 关键列表与详情内容依赖前端渲染与动态请求，普通请求拿不到有效表格；并且触发风控后返回内容不可用。  
**结果**: 必须切到真实浏览器驱动。

### -0.5 轻量级方案失败后切到当前方案
**失败原因**: 轻量级抓取拿不到稳定数据，且更容易触发拦截。  
**结果**: 最终固定为真实浏览器驱动（当前方案）+ Chrome 版本锁定。

### -0.3 直接拼接/复用详情页 URL
**失败原因**: 详情页入口不稳定，部分场景下链接并非明文可用（包含编码/跳转），直接拼接无法稳定复现详情内容。  
**结果**: 统一改为从搜索结果点击进入详情。

### -0.2 忽略瑞数反爬
**失败原因**: 常规 webdriver 或无头方案容易被拦截，页面返回异常或空结果。  
**结果**: 采用 undetected-chromedriver 并控制节奏与版本。

### 0. 试图单流程“列表翻页 + 详情回退”一把梭
**失败原因**: NMPA 列表页分页由 JS 维护，URL 不变；从详情页 `driver.back()` 会回到第 1 页，翻页状态丢失。  
**结果**: 采集容易遗漏；最终被拆成“两阶段”，先列表页建清单、再按编号进详情。

### 0.1 每条注册证都从首页重新进一次
**失败原因（基于旧代码/日志）**: 每条都 `get(home)` + 点分类 + 进库 + 搜索，耗时太大且更容易触发反爬；失败率和等待时间都飙升。  
**结果**: 改为“初始化一次搜索结果页，后续直接在结果页清空输入框换编号”。

### 0.2 搜索框选择器混用
**失败原因（已验证）**: 首页搜索框和结果页搜索框 selector 不同，用错会操作到左侧 select，导致实际没搜索。  
**结果**: 首页用 `.search-input`，结果页用 `.input-with-select`。

### 0.3 详情页表格解析误读
**失败原因（已验证）**: 详情页表格里存在 `key == "注"` 的行，实际是链接，不是字段值。  
**结果**: 解析时跳过 `注` 行，避免污染字段。

### 0.4 产品名称被截断直接过滤
**失败原因**: 列表页产品名过长会显示 `...`，若按规则直接过滤会把真实匹配项误删。  
**结果**: 含 `...` 的条目先保留，详情页补全再判断。

### 0.5 不做断点续传
**失败原因**: 采集过程中容易中断（网络/反爬/浏览器崩溃），重跑成本高。  
**结果**: 启动时读取 `nmpa_data.xlsx`，跳过已采集编号。

## 踩坑记录

### 1. 分页状态丢失问题
**问题**: NMPA网站使用JavaScript控制分页，URL不会随页码变化。点击详情后用`driver.back()`返回，页面会重置到第1页。

**解决方案**: 采用两阶段采集，第一阶段只翻页收集列表数据，第二阶段用注册证编号直接搜索获取详情，避免翻页问题。

### 2. 详情页数据提取
- 表格选择器: `#dataTable tbody tr`
- 每行两个td，第一个是key，第二个是value
- 用`.cell`子元素获取文本
- 跳过key为"注"的行（是链接不是数据）

### 3. 瑞数反爬
**解决方案**: 使用`undetected-chromedriver`库，并指定正确的Chrome版本号。

### 4. 产品名称截断
**问题**: 列表页产品名称过长会显示为"..."。

**解决方案**: 筛选时如果名称包含"..."直接保留，第二阶段获取详情时会得到完整名称。

### 5. 搜索结果页输入框选择器
**问题**: 首页和搜索结果页的搜索框选择器不同，用错选择器会误操作左侧的select下拉框。

- 首页搜索框: `.search-input input.el-input__inner`
- 搜索结果页搜索框: `.input-with-select input.el-input__inner`

**解决方案**: 第二阶段优化后，首次从首页进入用`.search-input`，后续在搜索结果页换编号用`.input-with-select`。

### 6. 第二阶段优化：避免重复初始化
**问题**: 原来每条记录都要从首页重新进入，太慢。

**解决方案**:
- 首次用第一条编号从首页搜索进入结果页
- 后续直接在搜索结果页清空输入框，输入新编号搜索
- 点击详情后用`driver.back()`返回搜索结果页继续

### 7. 断点续传
**问题**: 采集中断后需要从头开始。

**解决方案**: 启动时读取`nmpa_data.xlsx`已有数据，跳过已采集的注册证编号。

### 8. Excel文件被占用
**问题**: 保存时如果Excel文件被打开会报`PermissionError`。

**解决方案**: 运行采集时不要打开`nmpa_data.xlsx`文件。
